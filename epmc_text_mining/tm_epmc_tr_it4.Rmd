---
title: 'Extracting text mining predictions EPMC: Iteration 4'
author: "Pablo Porras"
date: "28/07/2017"
output: html_document
---

---
```{r set-options, echo=FALSE}
options(width = 80)
```
Text mining prediction EPMC: Technical report
========================================================

### Synopsis

We collaborated the EPMC team at EBI to use text-mining techniques that use a set of keywords (see Appendix) that describe potential interaction relationships to identify sentences that may depict interacting proteins. The sentences are extracted from the abstract or full text (when available, due to copyright restrictions) or publications listed in PubMed. The text-mining exercise was performed by Senay Kafkas (SK). Email exchange about this subject can be found in the folder ./source_files/emails. 

This version of the report refers to a fourth iteration of the text-mining process where PSI-MI CV was used to try and select only publications where CV terms under the 'interaction detection method' branch are found. The previous three iterations have been taken out for the sake of clarity and saving space in the repository. 

#### Evaluate and extract information from SK file

SK sent the result file from her search script on 2017/06/26. Here is the text of the email she sent on the first instance:  

*"I prepared the data for the iteration 3 evaluation:*

*/nfs/misc/literature/shenay/PPIExtraction/Data4ManualEval/Iteration3*


*You can randomly select any number of samples from this set. Please let me know if something is not clear."*

This the file format structure, as described by SK:

  1. PMC ID
  2. pubmed id
  3. publication date
  4. interacting protein pair, separated by ||. 
  5. All the supporting sentences for that specific pair extracted from that specific article, separated by ||||.
  6. section information where those sentences is coming from, separated by ||||.
  7. The interacting pairs extracted from those sentences (proteins are separated by ||), pairs are separated by ||||.
  8. Offsets of those proteins separated by ||||.
  9. PSI-MI CV term representing the interaction detection method, adding the section where the term was found. 

#### Uploading the text-mined dataset

I upload only the fields I need, so the file size does not get out of hand. 

```{r tm_upload, message=F, warning=F, cache=TRUE}
require(data.table)

setwd("./source_files/")
system("gunzip ./OA.PPI.June17.txt.gz")
setwd("../")
tm_sel <- fread("./source_files/OA.PPI.June17.txt", sep = "\t", header = F, drop=c(5,7,8),data.table = T)
colnames(tm_sel) <- c("pmcid","pmid","date","upacs","location","method_term")
system("gzip ./source_files/OA.PPI.June17.txt")
```

#### Extract protein and pair information

I need to extract the upacs and deal with the redundant ones. 
```{r format_data,message=FALSE}
tm_sel$upac_1 <- gsub("\\|\\|.*","",tm_sel$upacs)
tm_sel$upac_2 <- gsub(".*\\|\\|","",tm_sel$upacs)

library(splitstackshape)
tm_long_pt1 <- cSplit(tm_sel, "upac_1", sep = ",", direction = "long")
tm_long <- cSplit(tm_long_pt1, "upac_2", sep = ",", direction = "long")

tm_long$upac_1 <- as.character(tm_long$upac_1)
tm_long$upac_2 <- as.character(tm_long$upac_2)

publs <- unique(tm_long$pmid)
```

The data set contains `r length(publs)` publications potentially harbouring interaction data. Now I generate the pair ids for the text-mined dataset.

```{r,message=FALSE}
library(dplyr)
tm_long$pair_id <- apply(select(tm_long,upac_1,upac_2), 1,function(i){
  paste(sort(i),collapse = "_")
})
tm_long$tm <- 1
pairs <- unique(tm_long$pair_id)
```

There are `r length(pairs)` unique putative protein pairs in the dataset. I also generate a count of the number of times the protein or the detection method have been found. 

```{r scoring,message=FALSE}
library("stringr")
tm_long <- tm_long[,tm_pr_times_found:=(str_count(location,"\\|\\|\\|\\|")+1)][,tm_dm_times_found:=(str_count(method_term,"\\|\\|\\|\\|")+1)]    
```

#### Generating comparison file

```{r}
tm_lite <- unique(tm_long[,.(pair_id,pmid,tm,method_term,tm_pr_times_found,tm_dm_times_found)])
write.table(tm_lite,"./results/pairs_pmids_tm.txt",col.names=T,row.names=F,quote=F,sep="\t")
system("gzip ./results/pairs_pmids_tm.txt")
```
#### Generating a version of the file where methods can be searched

```{r}
tm_lite_met_long <- unique(cSplit(tm_lite,
                           splitCols = "method_term",
                           sep = "||||",
                           drop = F,
                           direction = "long"))

tm_lite_uniquemet <- tm_lite[!grepl("\\|\\|\\|\\|",method_term)]

tm_lite_met <- unique(rbind(tm_lite_met_long,tm_lite_uniquemet))

tm_lite_met <- tm_lite_met[,.(pair_id,
                              pmid,
                              tm,
                              method_term_simple = gsub("s$","",tolower(gsub("__.*","",method_term))),
                              tm_pr_times_found,
                              tm_dm_times_found)]

met_count <- data.table(table(tm_lite_met$method_term_simple,
                        useNA = "ifany"))
met_count[order(-N)]
```

##### Generating some stats for methods potentially detecting protein-nucleci acid interactions (PNAIs)
```{r}
potential_pnais <- tm_lite_met[grepl("one hybrid|one-hybrid|electrophoretic mobility shift assay|emsa|chromatin immunoprecipitation|chip|crac|y1h|clip",
                                     method_term_simple)]
pnais_count <- data.table(table(potential_pnais$method_term_simple,
                        useNA = "ifany"))

pnais_count[order(-N)]
```
Number of publications potentially containing PNAIs: `r nrow(unique(potential_pnais[,.(pmid)]))`.  
Number of potential unique PNAIs pairs: `r nrow(unique(potential_pnais[,.(pair_id)]))`.   
************************************************************